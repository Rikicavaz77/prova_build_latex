name: Build and Deploy
run-name: Build and Deploy (PDFs) on PR Merge

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches: 
      - main

jobs:
  docker:
    #if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Source Repository
      uses: actions/checkout@v4
      with:
          fetch-depth: 0

    - name: Cache Docker images
      uses: actions/cache@v4
      id: cache-docker
      with:
        path: /home/runner/.cache/docker
        key: ${{ runner.os }}-docker-${{ hashFiles('**/tools/docker-compose.yml') }}-${{ hashFiles('**/tools/docker/Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-docker-

    - name: Set Docker Build Environment Variable
      if: steps.cache-docker.outputs.cache-hit != 'true'
      run: |
        cd ${{ github.workspace }}/tools
        docker image load -i ubuntu:22-04
        
    - name: Start Docker Container
      if: steps.cache-docker.outputs.cache-hit == 'true'
      run: |
       docker compose up -d 
    
    - name: Compile Documents
      run: |
        cd ${{ github.workspace }}/tools
        docker exec argo-docs-latexpdfbuilder-1 bash -c 'cd /data && chmod +x *.sh && ./compilescript.sh -d RTB'
        echo "export FOLDER_PATH=$(pwd)/build-output" >> $GITHUB_ENV
    
    - name: Publish Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Docs
        path: build-output

    - name: Checkout Destination Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.FINE_GRAINED_TOKEN }}
        repository: Rikicavaz77/MTSS-Assignment-2
        fetch-depth: 0
        path: ./temp-checkout

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: Docs
        path: .

    - name: Upload Documents
      continue-on-error: true
      run: |
       if [ -d "RTB" ]; then
         if [ -d "RTB/Verbali/Esterni" ]; then
           rm -rf RTB/Verbali/Esterni
         fi
         cp -r RTB/* temp-checkout/RTB/
       fi
       if [ -d "PB" ]; then
         if [ -d "PB/Verbali/Esterni" ]; then
           rm -rf PB/Verbali/Esterni
         fi
         cp -r PB/* temp-checkout/RTB/
       fi
       cd ./temp-checkout
    
    - name: Push Documents
      continue-on-error: true
      run: |
        cd ./temp-checkout
        git config --global user.name 'github-actions'
        git config --global user.email 'riccardo.cavalli@studenti.unipd.it'
        git status 
        git add .
        git commit -m "[BOT] Caricamento PDF"
        git log --max-count=3
        git push -u origin
            
    - name: Checkout Back Source Repository
      continue-on-error: true
      run: cd ..
         
    - name: Stop Docker Container
      run: |
        cd ${{ github.workspace }}/tools
        docker compose stop
